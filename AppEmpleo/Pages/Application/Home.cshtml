@page
@model AppEmpleo.Pages.Application.HomeModel
@using AppEmpleo.Class.Utilities.Helpers
@using AppEmpleo.Models
@using Microsoft.AspNetCore.Authorization
@{
    ViewData["Title"] = "Ofertas de empleo";
    Layout = "~/Pages/Shared/_LayoutSession.cshtml";

    var countries = CountryHelper.CountryName;
    var currencies = CurrencyHelper.CurrencyName;
    var selectedWorkMode = string.IsNullOrWhiteSpace(Model.Offer?.WorkMode) ? "Remoto" : Model.Offer.WorkMode;
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/application-home.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/pages/application-home.js" asp-append-version="true"></script>
}

<div class="job-board">
    @if (Model.CurrentUser.Role == "CANDIDATO") 
    {
        <form class="job-board__search" autocomplete="off">
            <input id="jobSearchQuery" class="job-board__search-input" type="search" placeholder="Find a job" aria-label="Buscar oferta" />
            <select id="jobSearchLocation" class="job-board__search-select" aria-label="Ubicación">
                <option value="">Ubicación</option>
                @foreach (var country in countries)
                {
                    <option value="@country.Value">@country.Value</option>
                }
            </select>
            <button id="jobSearchButton" class="btn" type="submit">Search</button>
        </form>

        <div class="job-board__grid">
            <section class="job-results" aria-label="Resultados">
                <div class="job-results__header">
                    <h2 class="job-results__title">Resultados de busqueda</h2>
                    <span id="jobResultsCount" class="job-results__count"></span>
                </div>

                @if (Model.Offers.Count <= 0)
                {
                    <p class="job-results__count">No se han encontrado ofertas.</p>
                }
                else
                {
                    <ul class="job-results__list">
                        @foreach (var offer in Model.Offers)
                        {
                            var countryName = offer.Country;

                            if (Enum.TryParse<CountryCode>(offer.Country, out var countryKey) && countries.TryGetValue(countryKey, out var name))
                            {
                                countryName = name;
                            }

                            var salaryText = $"{offer.Currency} {offer.Salary}";
                            var datesText = $"Start {offer.StartDate} · Close {offer.EndDate}";
                            var locationText = $"{offer.WorkMode} · {countryName}";
                            var logoLetter = string.IsNullOrWhiteSpace(offer.JobTitle) ? "J" : offer.JobTitle.Trim().Substring(0, 1).ToUpperInvariant();

                            <li class="job-card"
                                data-offer-id="@offer.JobOfferId"
                                data-title="@offer.JobTitle"
                                data-recruiter="@(offer.Recruiter?.User.FirstName) @(offer.Recruiter?.User.LastName)"
                                data-description="@offer.Description"
                                data-salary="@salaryText"
                                data-dates="@datesText"
                                data-location="@locationText">

                                <div class="job-card__top">
                                    <div class="job-card__logo" aria-hidden="true">@logoLetter</div>
                                    <div>
                                        <h3 class="job-card__title">@offer.JobTitle</h3>
                                        <p class="job-card__company">@(offer.Recruiter?.User.FirstName) @(offer.Recruiter?.User.LastName)</p>
                                    </div>
                                </div>

                                <div class="job-card__tags">
                                    <span class="chip" data-chip>@offer.WorkMode</span>
                                    <span class="chip" data-chip>@countryName</span>
                                    <span class="chip" data-chip>@offer.Currency</span>
                                </div>

                                <div class="job-card__meta">
                                    <span class="job-card__salary">@salaryText</span>
                                    <span class="job-card__time">@offer.StartDate</span>
                                </div>
                            </li>
                        }
                    </ul>
                }
            </section>

            <aside class="job-detail" aria-label="Detalle de la oferta">
                <h2 class="job-detail__title">Select a job</h2>
                <div class="job-detail__subtitle">@*Aqui va el nombre del reclutador*@</div>

                <div class="job-detail__section">
                    <div class="job-detail__label">Descripción</div>
                    <div id="jobDetailDescription" class="job-detail__text">Pick an offer from the list to see details.</div>
                </div>

                <div class="job-detail__section">
                    <div class="job-detail__label">Habilidades</div>
                    <div id="jobDetailTags" class="job-detail__tags"></div>
                </div>

                <div class="job-detail__section">
                    <div class="job-detail__label">Salario</div>
                    <div id="jobDetailSalary" class="job-detail__text">--</div>
                </div>

                <div class="job-detail__section">
                    <div class="job-detail__label">Dates</div>
                    <div id="jobDetailDates" class="job-detail__text">--</div>
                </div>

                <div class="job-detail__section">
                    <div class="job-detail__label">Ubicación</div>
                    <div id="jobDetailLocation" class="job-detail__text">--</div>
                </div>

                <form asp-page-handler="Apply" method="post" enctype="multipart/form-data" class="job-detail__apply">
                    <input id="jobApplyOfferId" type="hidden" name="JobOfferId" value="" />
                    <div class="job-detail__file">
                        <label class="form-field__label" for="jobApplyFile">Upload your CV (PDF)</label>
                        <input id="jobApplyFile" class="job-detail__file-input" type="file" name="CVFile" accept=".pdf" required />
                        <div class="form-field__hint">Tip: use a short, well-formatted PDF for better readability.</div>
                    </div>
                    <button type="submit" class="btn btn--block">Apply Now</button>
                </form>
            </aside>
        </div>
    }
    else
    {
        <div class="offer-create">
            <div class="card offer-create__card">
                <h2 class="offer-create__title">Crear oferta laboral</h2>

                <form method="post" asp-page="Home" class="form offer-create__form" autocomplete="off">
                    <div class="offer-create__grid">
                        <div class="form-field form-field--full">
                            <label asp-for="Offer.JobTitle" class="form-field__label"></label>
                            <input asp-for="Offer.JobTitle" type="text" class="form-field__input" placeholder="Frontend Developer" />
                        </div>

                        <div class="form-field">
                            <label asp-for="Offer.StartDate" class="form-field__label"></label>
                            <input asp-for="Offer.StartDate" type="date" class="form-field__input" />
                        </div>

                        <div class="form-field">
                            <label asp-for="Offer.EndDate" class="form-field__label"></label>
                            <input asp-for="Offer.EndDate" type="date" class="form-field__input" />
                        </div>

                        <div class="form-field">
                            <label asp-for="Offer.Country" class="form-field__label"></label>
                            <input asp-for="Offer.Country" class="form-field__input" list="countryList" placeholder="Country" />
                            <datalist id="countryList">
                                @foreach (var country in countries)
                                {
                                    <option value="@country.Key">@country.Value</option>
                                }
                            </datalist>
                        </div>

                        <div class="form-field">
                            <label asp-for="Offer.Currency" class="form-field__label"></label>
                            <input asp-for="Offer.Currency" class="form-field__input" list="currencyList" placeholder="Currency" />
                            <datalist id="currencyList">
                                @foreach (var currency in currencies)
                                {
                                    <option value="@currency.Key">@currency.Value</option>
                                }
                            </datalist>
                        </div>

                        <div class="form-field">
                            <label asp-for="Offer.Salary" class="form-field__label"></label>
                            <input asp-for="Offer.Salary" type="number" class="form-field__input" placeholder="1000" />
                        </div>

                        <div class="form-field form-field--full">
                            <label class="form-field__label">Work mode</label>
                            <div class="radio-group" role="radiogroup" aria-label="Modalidad">
                                <label class="radio-pill">
                                    <input type="radio" name="Offer.WorkMode" value="Remoto" checked="@(selectedWorkMode == "Remoto")" />
                                    Remoto
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="Offer.WorkMode" value="Presencial" checked="@(selectedWorkMode == "Presencial")" />
                                    Presencial
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="Offer.WorkMode" value="Híbrido" checked="@(selectedWorkMode == "Híbrido")" />
                                    Híbrido
                                </label>
                            </div>
                        </div>

                        <div class="form-field form-field--full">
                            <label asp-for="Offer.Description" class="form-field__label"></label>
                            <input asp-for="Offer.Description" type="text" class="form-field__input" placeholder="Short description…" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn--block">Publicar oferta</button>
                </form>
            </div>

            <section class="offer-list" aria-label="Offers">
                <div class="offer-list__header">
                    <h2 class="offer-list__title">Your latest offers</h2>
                    <span class="offer-list__count">@Model.TotalOffers total</span>
                </div>

                @if (Model.Offers.Count <= 0)
                {
                    <p class="job-results__count">No job offers found.</p>
                }
                else
                {
                    <ul class="offer-list__grid">
                        @foreach (var offer in Model.Offers)
                        {
                            var countryName = offer.Country;

                            if (Enum.TryParse<CountryCode>(offer.Country, out var countryKey) && countries.TryGetValue(countryKey, out var name))
                            {
                                countryName = name;
                            }

                            var salaryText = $"{offer.Currency} {offer.Salary}";
                            var datesText = $"Start {offer.StartDate} · Close {offer.EndDate}";
                            var logoLetter = string.IsNullOrWhiteSpace(offer.JobTitle) ? "J" : offer.JobTitle.Trim().Substring(0, 1).ToUpperInvariant();

                            <li class="job-card">
                                <div class="job-card__top">
                                    <div class="job-card__logo" aria-hidden="true">@logoLetter</div>
                                    <div>
                                        <h3 class="job-card__title">@offer.JobTitle</h3>
                                        <p class="job-card__company">JobTI</p>
                                    </div>
                                </div>

                                <div class="job-card__tags">
                                    <span class="chip" data-chip>@offer.WorkMode</span>
                                    <span class="chip" data-chip>@countryName</span>
                                    <span class="chip" data-chip>@offer.Currency</span>
                                </div>

                                <div class="job-card__meta">
                                    <span class="job-card__salary">@salaryText</span>
                                    <span class="job-card__time">@datesText</span>
                                </div>
                            </li>
                        }
                    </ul>
                }

                <div class="pager">
                    @if (Model.TotalPages > 1)
                    {
                        <nav aria-label="Paginación de ofertas">
                            <ul class="pager__list">
                                <li>
                                    <a asp-page="Home" asp-route-pageNumber="@(Model.CurrentPage - 1)" class="pager__link @(Model.CurrentPage == 1 ? "pager__link--disabled" : "")">Previous</a>
                                </li>
                                @for (int i = 1; i <= Model.TotalPages; i++)
                                {
                                    <li>
                                        <a asp-page="Home" asp-route-pageNumber="@i" class="pager__link @(Model.CurrentPage == i ? "pager__link--active" : "")">@i</a>
                                    </li>
                                }
                                <li>
                                    <a asp-page="Home" asp-route-pageNumber="@(Model.CurrentPage + 1)" class="pager__link @(Model.CurrentPage == Model.TotalPages ? "pager__link--disabled" : "")">Next</a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </section>
        </div>
    }
</div>
